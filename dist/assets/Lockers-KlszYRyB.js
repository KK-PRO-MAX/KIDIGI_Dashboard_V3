import{q as _e,r as g,c as I,o as ke,v as ye,x as Ae,a as m,d as n,y as q,e as i,w as u,z as _,g as f,F as D,l as N,t as k,u as Q,A as Le,B as we,C as be,m as r,D as Ce,b as p,G as Y,H as Be,n as Ie,I as $,_ as Te}from"./index-v1DWNmr-.js";import{u as Ve}from"./filterStore-CsKhuLzX.js";import{g as he,a as De,b as Ne}from"./locker-DrIPEVPp.js";import"./index-B9ygI19o.js";const Se="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAASCAYAAABB7B6eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAFESURBVHgB1VPBVcMwDP2BBcIGGqEb1BtQJkg4wRE26AawAWaCPCYgTEC5cUs3aDtBK8Xqs+u0tdNb/3v/JZElWdJXCpxGyZwxp8wJk9QmWDOXzAWzZf7odxYMs2GumNsR/NAizlb8FgXJJe/MWi8m7caozTK7nIsmkeO3JsmF0Zh9fKc5e1Tw4+gwLnGMGr5QyVkV+iLjEcEeMBTLwAlN8K2LyH9wAreRv/g02oH49TO28BsSVvOLtLhScRXFlprzpcAQBCeUCWytVrwIfKZHfB6RWFfCodhzDDuL/S0Ou6Ez/n3CwRZkgILC5uHBbeS4ZG6Yr8z/wC5dPDGf4f7uUv3Wei7PL7XZwJ6FcI1jcWep4CJxXmryfZWf+n4PP+s7jKw4hsVxsWW9G1wTCG5cozbsBvmo4cZEyBD3EhBc9cmfKcQOrCty3Gv5abYAAAAASUVORK5CYII=",xe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAASCAYAAABB7B6eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAIuSURBVHgBnVQ9UsJAFN4EhrFisLSLJ1AvgLG0Ek9gPAHa8idhBup4AkOnFXACAlRWxBMQOss4NA7Dj9/LvDBLTAB9M8vuY9/7vve3UUREarVaUVXVQb1ed7H01Wp1pijKOXYNu0Y26/Xaw+ZDd2D7ATtHJIgiK9Vq1YDTC6sGgE6hP4n94mHZIGuDzEskwCVF2scxJ5EcU+TYXSyfFoA03NG6xJ0uQfhYVqPRMLcIAKwBuINjF869KAkc2iJB4JtbLpcFzlQLMwLOFWWjcNQdvvQXi8VVJpMRfyEJBSV+YCLy84B1q6CpEwbfsLKx3I+AhBqKEhUR8RfOYx4GL5KRxsEFAav46cGJpuFCNk6lUlTze8nXms/nlNkUtkXoNs4TBNKnaZMIgkARXBf3bUXE1/QFBgVSQTKVMglKCHKq+Q3089APdvZsNnu0LMuX8dSY9MYMLmh64NSVMsml0+k+AuiiJxeI9BT/tdnWyGazY8KQMdOyAkeDH5OH832z2XT4ykYpBGcSkJRKJeqXC90ol8s2sqI7jTAo1tgMYGRje6YaSuBB2fgNbGUCkqBEZEs+5MsYG/nVg6hUKpUCnIPIRUJPWq2Wm+Sv7gKnyAHeYXD69lAJ3KRM4iS1i8BxnG9d1+khviP1a9M030aj0edwOHTz+fyUh+EIQZwMBoPXOIy9JdolVD4Q34HI5Ib/nyAcYUGvU3rx+0QVBwqPH/UiHMWD5GACHj+PVnQUd8kPKHJIo9vmQBUAAAAASUVORK5CYII=",Ue={class:"locker-container"},Ee={class:"header-bar"},Re={class:"action-buttons"},Me={class:"filter-section"},Fe={key:0,class:"restore-notification"},Pe={class:"restore-content"},Ye={class:"restore-text"},Ge={key:1,class:"loading-container"},Ke={key:2,class:"empty-container"},Xe={key:3,class:"locker-grid"},Je={class:"card-content"},Qe={class:"card-header"},ze={class:"name-wrapper"},Oe={class:"name"},We={class:"wifi-icon-container"},He={key:0,src:Se,alt:"wifi",class:"wifi-icon"},je={key:1,src:xe,alt:"wifi",class:"wifi-icon"},Ze={class:"bottom-icons"},qe={class:"info-section"},$e={class:"info-row available-row"},eo={class:"info-row damaged-row"},oo={key:4,class:"pagination-container"},lo={class:"dialog-footer"},to=_e({__name:"Lockers",setup(ao){const z=Ve(),ee=Ce(),oe=we,C=g(!1),S=g(!1),O=g(-1),W=g(null),d=g({name:"",sn:"",location:0,lockerType:0}),x=g(!1),U=g(null),E=g(30);let y=null;const A=g([]),L=g([]),v=g([]),G=g(!1);g("");const R=g(""),w=g(1),B=g(8),M=I({get:()=>z.selectedCategory,set:o=>z.setCategory(o)}),H=async()=>{var e;const o=localStorage.getItem("token");if(console.log("Token检查:",o?"存在":"不存在"),!o){console.warn("Token not found, please login first"),r.warning("Please login first");return}G.value=!0;try{console.log("=== 开始请求Locker列表 (locker_list_select) ===");const l=await he();console.log("=== API响应成功 ==="),console.log("响应状态:",l.status),console.log("响应数据:",l.data);const a=l.data;if(a.ret_data&&a.ret_data.length>0&&console.log("第一条原始数据:",a.ret_data[0]),a.ret===0&&(a.code===200||a.code==="200")){let c=a.ret_data||[];Array.isArray(c)||(c=typeof c=="string"?JSON.parse(c):[]),c=c.map(s=>({id:s.id,name:s.name,sn_code:s.sn_code,location:s.location,location_id:s.location_id,locker_code:s.locker_code,locker_type:s.locker_type,locker_type_id:s.locker_type_id,bay_total:s.bay_total||0,create_time:s.create_time||Date.now(),update_time:s.update_time||Date.now(),update_user:s.update_user||"",locker_status:s.locker_status||0,Devices_in_use:s.Devices_in_use||s["Devices in use"]||0,available_device:s.available_device||s["available device"]||0,damaged_device:s.damaged_device||s["damaged device"]||0})),v.value=[...c],console.log("✓ Locker数据加载成功，共",v.value.length,"条"),w.value=1,v.value.length===0?(console.warn("⚠ The API returned empty data."),r.info("No Locker data")):(console.log("第一number of data entries的所有字段:",Object.keys(v.value[0])),r.success(`Loading successful ${v.value.length} number of data entries`))}else console.error("✗ API返回错误:",a),r.error(a.msg||"Failed to fetch Locker list"),v.value=[]}catch(l){console.error("=== 请求失败 ==="),console.error("错误对象:",l),console.error("错误消息:",l.message);let a="Network error";l.response?a=((e=l.response.data)==null?void 0:e.msg)||`Server error (${l.response.status})`:l.request?a="Unable to connect to server, please check network":a=l.message,r.error(a),v.value=[]}finally{G.value=!1,console.log("=== 请求结束 ===")}};I(()=>{const o=v.value.map(e=>e.location);return[...new Set(o)].sort()});const le=I(()=>{const o=L.value.map(e=>e.locker_type);return[...new Set(o)].sort()}),T=I(()=>{if(console.log("计算 filteredLockers, lockers.value:",v.value),console.log("lockers.value 长度:",v.value.length),!v.value||v.value.length===0)return console.log("lockers.value 为空"),[];let o=v.value.map(e=>{var h,b,F,P;const l=A.value.find(t=>t.id===e.location_id),a=((h=l==null?void 0:l.location)==null?void 0:h.trim())||"Not Set",c=L.value.find(t=>t.id===e.locker_type_id),s=((b=c==null?void 0:c.locker_type)==null?void 0:b.trim())||"Not Set",V=Number(e.Devices_in_use)||0,X=Number(e.available_device)||0,J=Number(e.damaged_device)||0;return{id:e.id||Date.now(),originalId:e.id,name:((F=e.name)==null?void 0:F.trim())||`Unnamed-${e.id||Math.random().toString(36).substr(2,4)}`,sn:((P=e.sn_code)==null?void 0:P.trim())||"No SN Code",location:a,location_id:e.location_id||0,lockerType:s,locker_type_id:e.locker_type_id||0,devicesInUse:V,availableDevices:X,damagedDevices:J,online:e.locker_status===1,category:`A${e.id||Math.random().toString(36).substr(2,4)}`}});return M.value&&(o=o.filter(e=>e.lockerType===M.value)),R.value&&(o=o.filter(e=>String(e.location_id)===R.value)),o}),j=I(()=>{const o=(w.value-1)*B.value,e=o+B.value;return T.value.slice(o,e)}),te=I(()=>Math.ceil(T.value.length/B.value)),ae=async()=>{try{if(!localStorage.getItem("token")){console.warn("Token not found, please login first");return}const e=await De();console.log("Location列表响应:",e.data);const l=e.data;l.ret===0&&(l.code===200||l.code==="200")?(A.value=l.ret_data||[],console.log("✓ Location数据加载成功，共",A.value.length,"条")):(console.error("✗ Location API返回错误:",l),A.value=[])}catch(o){console.error("获取Location列表失败:",o),A.value=[]}},ne=async()=>{try{if(!localStorage.getItem("token")){console.warn("Token not found, please login first");return}const e=await Ne();console.log("Locker Type列表响应:",e.data);const l=e.data;l.ret===0&&(l.code===200||l.code==="200")?(L.value=l.ret_data||[],console.log("✓ Locker Type数据加载成功，共",L.value.length,"条")):(console.error("✗ Locker Type API返回错误:",l),L.value=[])}catch(o){console.error("获取Locker Type列表失败:",o),L.value=[]}},K=async()=>{console.log("=== 加载Lockers页面数据 ==="),await Promise.all([ae(),ne()]),await H()};ke(()=>{console.log("=== Lockers页面已挂载 ==="),K()}),ye(()=>{console.log("=== Lockers页面已激活（从其他页面返回）==="),K()}),Ae(()=>ee.path,(o,e)=>{o==="/Lockers"&&e&&e!=="/Lockers"&&(console.log("=== 路由变化检测：从",e,"返回到Lockers ==="),K())});const se=o=>{const e=(w.value-1)*B.value+o;if(e===-1||e>=T.value.length)return;const l=T.value[e];$.confirm("Are you sure you want to delete this locker? You can restore it within 30 seconds.",{confirmButtonText:"Delete",cancelButtonText:"Cancel",type:"warning",confirmButtonClass:"confirm-delete-btn",cancelButtonClass:"cancel-delete-btn"}).then(()=>{try{const a=v.value.findIndex(c=>c.id===(l.originalId||l.id));a!==-1&&v.value.splice(a,1),U.value=l.id,x.value=!0,E.value=30,r.success("Locker deleted successfully. You can restore it within 30 seconds."),ce()}catch{r.error("Failed to delete locker")}}).catch(()=>{r.info("Delete cancelled")})},re=o=>{console.log("切换到第",o,"页"),w.value=o,window.scrollTo({top:0,behavior:"smooth"})},ce=()=>{y&&clearInterval(y),y=setInterval(()=>{E.value--,E.value<=0&&(y&&clearInterval(y),x.value=!1,U.value=null)},1e3)},ie=()=>{if(!U.value){r.warning("No locker to restore");return}try{$.confirm("Do you want to restore this locker?",{confirmButtonText:"Restore",cancelButtonText:"Cancel",type:"info",confirmButtonClass:"confirm-restore-btn",cancelButtonClass:"cancel-restore-btn"}).then(()=>{x.value=!1,U.value=null,y&&clearInterval(y),r.success("Restored successfully")}).catch(()=>{r.info("Restore cancelled")})}catch{r.error("Restore failed")}},de=()=>{S.value=!1,O.value=-1,d.value={name:"",sn:"",location:0,lockerType:0},C.value=!0},ue=(o,e)=>{if(!o||typeof o!="object"){r.error("Invalid locker data");return}(!o.location_id||!o.locker_type_id)&&(console.warn("⚠ Locker数据不完整:",o),r.warning("Locker data is incomplete, some fields may be missing")),S.value=!0;const l=(w.value-1)*B.value+e;O.value=l,W.value=o,d.value={name:o.name||"",sn:o.sn||"",location:o.location_id||0,lockerType:o.locker_type_id||0},console.log("=== 打开编辑对话框 ==="),console.log("Locker数据:",o),console.log("表单数据:",d.value),C.value=!0},ve=()=>{var c,s;const o=(c=d.value.name)==null?void 0:c.trim(),e=(s=d.value.sn)==null?void 0:s.trim(),l=d.value.location,a=d.value.lockerType;return console.log("=== 表单验证 ==="),console.log("name:",o,"是否有效:",!!o),console.log("sn:",e,"是否有效:",!!e),console.log("location:",l,"是否有效:",!!l),console.log("lockerType:",a,"是否有效:",!!a),o?e?l?a?typeof l!="number"||l<=0?(r.error("Invalid location selected"),!1):typeof a!="number"||a<=0?(r.error("Invalid locker type selected"),!1):!0:(r.warning("Please select locker type"),!1):(r.warning("Please select location"),!1):(r.warning("Please enter serial number"),!1):(r.warning("Please enter locker name"),!1)},pe=()=>{ve()&&(async()=>{try{S.value?await ge():await fe(),C.value=!1}catch(o){console.error("保存失败:",o)}})()},ge=async()=>{try{const o=W.value;if(!o){r.error("Failed to find locker to edit");return}const e=d.value.location,l=d.value.lockerType,a=d.value.name.trim(),c=d.value.sn.trim();if(console.log("=== 参数检查 ==="),console.log("location_id:",e,"类型:",typeof e),console.log("locker_type_id:",l,"类型:",typeof l),console.log("name:",a),console.log("sn_code:",c),!e||isNaN(e)){r.error("Invalid location_id: "+e);return}if(!l||isNaN(l)){r.error("Invalid locker_type_id: "+l);return}const s=v.value.findIndex(V=>V.id===o.id);s!==-1?(v.value[s]={...v.value[s],name:a,sn_code:c,location_id:e,locker_type_id:l,update_time:Date.now()},console.log("✓ Locker编辑成功，ID:",o.id),r.success("Locker updated successfully")):(console.error("✗ 未找到要编辑的Locker"),r.error("Failed to find locker to update"))}catch(o){console.error("=== 编辑失败 ==="),console.error("错误对象:",o),console.error("错误消息:",o.message);const e=o.message||"Failed to update locker";r.error(e)}},fe=async()=>{try{const o=d.value.location,e=d.value.lockerType,l=d.value.name.trim(),a=d.value.sn.trim();if(console.log("=== 参数检查 ==="),console.log("location_id:",o,"类型:",typeof o),console.log("locker_type_id:",e,"类型:",typeof e),console.log("name:",l),console.log("sn_code:",a),!o||isNaN(o)){r.error("Invalid location_id: "+o);return}if(!e||isNaN(e)){r.error("Invalid locker_type_id: "+e);return}const c={id:Date.now(),name:l,sn_code:a,location:"",location_id:o,locker_code:"LC"+Date.now(),locker_type:"",locker_type_id:e,bay_total:32,locker_status:1,create_time:Date.now(),update_time:Date.now(),update_user:"local_user",Devices_in_use:0,available_device:32,damaged_device:0};v.value.push(c),console.log("✓ Locker添加成功，ID:",c.id),r.success("Locker added successfully"),d.value={name:"",sn:"",location:0,lockerType:0}}catch(o){console.error("=== 添加失败 ==="),console.error("错误:",o.message),r.error("Failed to add locker")}};return(o,e)=>{const l=_("el-button"),a=_("router-link"),c=_("el-option"),s=_("el-select"),V=_("el-icon"),X=_("el-empty"),J=_("el-pagination"),h=_("el-input"),b=_("el-form-item"),F=_("el-form"),P=_("el-dialog");return p(),m("div",Ue,[n("div",Ee,[e[12]||(e[12]=n("h2",null,"Lockers",-1)),n("div",Re,[i(a,{to:"/Locker_Type"},{default:u(()=>[i(l,{type:"",class:"locker-type-btn"},{default:u(()=>[...e[9]||(e[9]=[f("Locker Type",-1)])]),_:1})]),_:1}),i(a,{to:"/Location"},{default:u(()=>[i(l,{type:"",class:"location-btn"},{default:u(()=>[...e[10]||(e[10]=[f("Location",-1)])]),_:1})]),_:1}),i(l,{type:"",style:{"background-color":"#0C306C",color:"#fff","font-weight":"600"},onClick:de},{default:u(()=>[...e[11]||(e[11]=[f(" Add Locker ",-1)])]),_:1})])]),n("div",Me,[i(s,{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=t=>M.value=t),placeholder:"All Locker Types",clearable:"",style:{width:"250px","margin-right":"10px"}},{default:u(()=>[i(c,{label:"All Locker Types",value:""}),(p(!0),m(D,null,N(le.value,t=>(p(),Y(c,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),i(s,{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=t=>R.value=t),placeholder:"All Locations",clearable:"",style:{width:"250px","margin-right":"10px"},onChange:H},{default:u(()=>[i(c,{label:"All Locations",value:""}),(p(!0),m(D,null,N(A.value,t=>(p(),Y(c,{key:t.id,label:t.location,value:String(t.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),x.value?(p(),m("div",Fe,[n("div",Pe,[n("span",Ye,[e[13]||(e[13]=f("Locker deleted, can be restored within ",-1)),n("strong",null,k(E.value),1),e[14]||(e[14]=f(" seconds",-1))]),i(l,{type:"primary",size:"small",class:"restore-btn",onClick:ie},{default:u(()=>[...e[15]||(e[15]=[f(" Restore ",-1)])]),_:1})])])):q("",!0),G.value?(p(),m("div",Ge,[i(V,{class:"is-loading",size:40},{default:u(()=>[i(Q(Le))]),_:1}),e[16]||(e[16]=n("p",null,"Loading...",-1))])):j.value.length===0?(p(),m("div",Ke,[i(X,{description:"No Locker Data"}),e[17]||(e[17]=n("p",{style:{"margin-top":"20px",color:"#909399"}},null,-1))])):(p(),m("div",Xe,[(p(!0),m(D,null,N(j.value,(t,Z)=>(p(),m("div",{key:t.id,class:"locker-card"},[n("div",Je,[n("div",Qe,[n("div",ze,[e[18]||(e[18]=n("span",{class:"label"},"Name : ",-1)),n("span",Oe,k(t.name),1)]),n("div",We,[t.online?(p(),m("img",He)):(p(),m("img",je))]),n("div",Ze,[e[19]||(e[19]=n("i",{class:"el-icon-bell",style:{color:"#FF0400"}},null,-1)),n("i",{class:Ie(t.online?"el-icon-wifi":"el-icon-wifi-off"),style:Be(t.online?"color: #2c3e50;":"color: #ccc;")},null,6)])]),n("div",qe,[n("p",null,[e[20]||(e[20]=n("span",{class:"label"},"SN:",-1)),f(" "+k(t.sn),1)]),n("p",null,[e[21]||(e[21]=n("span",{class:"label"},"Location:",-1)),f(" "+k(t.location),1)]),n("p",null,[e[22]||(e[22]=n("span",{class:"label"},"Locker Type:",-1)),f(" "+k(t.lockerType),1)]),n("p",null,[e[23]||(e[23]=n("span",{class:"label"},"Devices In Use:",-1)),f(" "+k(t.devicesInUse),1)]),n("div",$e,[n("p",null,[e[24]||(e[24]=n("span",{class:"label"},"Available Devices:",-1)),f(" "+k(t.availableDevices),1)]),i(l,{type:"",class:"action-btn edit-btn",onClick:me=>ue(t,Z)},{default:u(()=>[...e[25]||(e[25]=[f(" Edit ",-1)])]),_:1},8,["onClick"])]),n("div",eo,[n("p",null,[e[26]||(e[26]=n("span",{class:"label"},"Damaged Devices:",-1)),f(" "+k(t.damagedDevices),1)]),i(l,{class:"action-btn delete-btn",onClick:me=>se(Z)},{default:u(()=>[...e[27]||(e[27]=[f(" Delete ",-1)])]),_:1},8,["onClick"])])])])]))),128))])),te.value>1?(p(),m("div",oo,[i(Q(be),{locale:Q(oe)},{default:u(()=>[i(J,{"current-page":w.value,"onUpdate:currentPage":e[2]||(e[2]=t=>w.value=t),"page-size":B.value,total:T.value.length,layout:"prev, pager, next",background:"",onCurrentChange:re},null,8,["current-page","page-size","total"])]),_:1},8,["locale"])])):q("",!0),i(P,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=t=>C.value=t),title:S.value?"Edit Locker":"Add Locker",width:"565px",style:{"--you-dialog-width":"565px","font-weight":"700",color:"#000",gap:"28px","border-radius":"24px","padding-top":"52px","padding-right":"24px","padding-bottom":"52px","padding-left":"24px"},"custom-class":"custom-dialog","close-on-click-modal":!1},{footer:u(()=>[n("span",lo,[i(l,{type:"default",class:"cancel-btn",onClick:e[7]||(e[7]=t=>C.value=!1)},{default:u(()=>[...e[28]||(e[28]=[f("Cancel",-1)])]),_:1}),i(l,{type:"primary",class:"save-btn",onClick:pe},{default:u(()=>[...e[29]||(e[29]=[f("Save",-1)])]),_:1})])]),default:u(()=>[i(F,{model:d.value,"label-position":"top",class:"locker-form"},{default:u(()=>[i(b,{label:"Name*"},{default:u(()=>[i(h,{modelValue:d.value.name,"onUpdate:modelValue":e[3]||(e[3]=t=>d.value.name=t),placeholder:"Enter locker name (e.g., A1, A2)"},null,8,["modelValue"])]),_:1}),i(b,{label:"SN*"},{default:u(()=>[i(h,{modelValue:d.value.sn,"onUpdate:modelValue":e[4]||(e[4]=t=>d.value.sn=t),placeholder:"Enter serial number (e.g., 60394AFA)"},null,8,["modelValue"])]),_:1}),i(b,{label:"Location*"},{default:u(()=>[i(s,{modelValue:d.value.location,"onUpdate:modelValue":e[5]||(e[5]=t=>d.value.location=t),placeholder:"Select location",style:{width:"100%"}},{default:u(()=>[(p(!0),m(D,null,N(A.value,t=>(p(),Y(c,{key:t.id,label:t.location,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),i(b,{label:"Locker Type*"},{default:u(()=>[i(s,{modelValue:d.value.lockerType,"onUpdate:modelValue":e[6]||(e[6]=t=>d.value.lockerType=t),placeholder:"Select locker type",style:{width:"100%"}},{default:u(()=>[(p(!0),m(D,null,N(L.value,t=>(p(),Y(c,{key:t.id,label:t.locker_type,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),io=Te(to,[["__scopeId","data-v-6cb57ce2"]]);export{io as default};
